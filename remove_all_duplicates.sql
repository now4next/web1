-- 모든 중복 역량 제거 스크립트
-- 전략: 각 중복 역량에서 가장 상세한 정의와 많은 행동 지표를 가진 것을 유지

-- ============================================================================
-- 중요: 이 스크립트를 실행하기 전에 check_all_duplicates.sql로 먼저 확인하세요!
-- ============================================================================

-- 방법 1: 특정 역량 모델의 중복만 제거 (권장)
-- "경영지원 직무역량"과 "역량 평가표"가 중복되는 경우, "역량 평가표"를 유지

-- 1단계: 리더십 중복 제거 준비
-- 각 리더십 역량의 ID와 행동 지표 수를 확인한 후 수동으로 삭제할 ID를 결정

-- 2단계: 문제해결 중복 제거 준비
-- 각 문제해결 역량의 ID와 행동 지표 수를 확인한 후 수동으로 삭제할 ID를 결정

-- 3단계: 시장분석 중복 제거 준비
-- 각 시장분석 역량의 ID와 행동 지표 수를 확인한 후 수동으로 삭제할 ID를 결정

-- 4단계: 커뮤니케이션 중복 제거 준비
-- 각 커뮤니케이션 역량의 ID와 행동 지표 수를 확인한 후 수동으로 삭제할 ID를 결정

-- ============================================================================
-- 일반적인 중복 제거 전략
-- ============================================================================

-- 전략 A: 가장 오래된 것을 유지 (최소 ID)
-- 각 keyword의 최소 ID를 제외한 모든 중복 삭제
-- 주의: 이 방법은 최신 데이터가 더 나을 수 있으므로 신중하게 사용

-- 전략 B: 특정 모델 우선순위
-- 예: "역량 평가표" > "경영지원 직무역량" > 기타
-- 아래는 예시 - 실제 상황에 맞게 조정 필요

-- ============================================================================
-- 실행 예시: 특정 ID로 직접 삭제 (가장 안전)
-- ============================================================================

-- 아래 주석을 해제하고 실제 삭제할 ID를 입력하세요
-- check_all_duplicates.sql의 결과를 보고 어떤 ID를 삭제할지 결정

-- 예시: ID 10, 11을 삭제하려는 경우
-- DELETE FROM behavioral_indicators WHERE competency_id IN (10, 11);
-- DELETE FROM competencies WHERE id IN (10, 11);

-- ============================================================================
-- 자동화된 중복 제거 (위험: 신중하게 사용)
-- ============================================================================

-- 다음 스크립트는 각 keyword에서 ID가 가장 작은 것만 남기고 나머지를 삭제
-- 경고: 이 방법은 데이터 손실 위험이 있으므로 백업 후 사용!

-- 주석 해제하여 사용:
/*
-- 중복 역량의 행동 지표 삭제
DELETE FROM behavioral_indicators 
WHERE competency_id IN (
  SELECT c.id 
  FROM competencies c
  WHERE c.keyword IN ('리더십', '문제해결', '시장분석', '커뮤니케이션')
  AND c.id NOT IN (
    -- 각 keyword의 최소 ID (가장 먼저 생성된 것)만 유지
    SELECT MIN(id) 
    FROM competencies 
    WHERE keyword IN ('리더십', '문제해결', '시장분석', '커뮤니케이션')
    GROUP BY keyword
  )
);

-- 중복 역량 삭제
DELETE FROM competencies 
WHERE keyword IN ('리더십', '문제해결', '시장분석', '커뮤니케이션')
AND id NOT IN (
  -- 각 keyword의 최소 ID만 유지
  SELECT MIN(id) 
  FROM competencies 
  WHERE keyword IN ('리더십', '문제해결', '시장분석', '커뮤니케이션')
  GROUP BY keyword
);
*/

-- ============================================================================
-- 검증
-- ============================================================================

-- 중복 확인 (결과가 비어있어야 함)
SELECT keyword, COUNT(*) as count 
FROM competencies 
GROUP BY keyword 
HAVING count > 1;

-- 총 역량 수 확인
SELECT COUNT(*) as total_competencies FROM competencies;

-- 역량 모델별 개수
SELECT cm.name, COUNT(c.id) as count
FROM competencies c
JOIN competency_models cm ON c.model_id = cm.id
GROUP BY cm.name;
